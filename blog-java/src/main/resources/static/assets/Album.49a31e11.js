import{_ as B,bz as T,E as x,A as I,a as H,b as q,r as U,d as M,e as j,ao as z,ap as K,aq as J,o as g,f as b,g as a,w as i,h as d,i as A,j as p,k as N,F as k,l as C,t as W,m as X,v as G,p as Q,n as Y}from"./index.de08f477.js";import{b as Z,E as $,a as ee,c as te}from"./el-select.8c19de9d.js";import"./el-tag.4a35146c.js";/* empty css                */import{a as le,b as ae,E as se}from"./el-image-viewer.660ee909.js";const ie={components:{Plus:T},props:["authorId"],data(){return{albumsB:[],albums:[],albumsA:[],originalImg:[],simplifyImg:[],progress:{percentage:0,show:!1,status:""},albumName:"",fileList:[],previewDialog:!1,dialogImageUrl:"",uploadDialog:!1,editAlbumDialog:!1,rules:{albumName:{required:!0,message:"\u8BF7\u8F93\u5165\u76F8\u518C\u540D",trigger:"blur"}},OKFlag:!0}},methods:{previewImage(t){this.dialogImageUrl=this.originalImg[t],this.previewDialog=!0},handleRemove(t,e){},handlePictureCardPreview(t){this.dialogImageUrl=t.url,this.previewDialog=!0},dealImage(t,e){var l=new Image,m=.8;l.src=t,l.setAttribute("crossOrigin","Anonymous");var s,o;return new Promise(u=>{l.onload=function(){s=this.width,o=this.height;var r=document.createElement("canvas"),h=r.getContext("2d");let f=3200*(e/1e3);Math.max(s,o)>f?s>o?(r.width=f,r.height=f*o/s):(r.height=f,r.width=f*s/o):(r.width=s,r.height=o,m=1),h.clearRect(0,0,r.width,r.height),h.drawImage(this,0,0,r.width,r.height);var w=r.toDataURL("image/webp",m);let v=w.length*.75/1024;for(;v>e;)m-=.1,w=r.toDataURL("image/webp",m),v=w.length*.75/1024;u(w)}})},uploadHandler(){this.progress.unit=Math.round(1/this.fileList.length*100)},exceedHandler(){x({showClose:!0,message:"\u56FE\u7247\u6570\u91CF\u8D85\u51FA\u9650\u5236",type:"warning"})},stopUpload(){this.fileList.forEach(t=>{this.$refs.uploadRef.abort(t.raw)})},async upload(){if(this.albumName==""){x({showClose:!0,message:"\u8BF7\u9009\u62E9\u76F8\u518C",type:"warning"});return}let t=0;this.fileList.forEach(l=>{l.status=="ready"&&(l.status="uploading",l.percentage=0,t++)}),this.progress.status="",this.progress.show=!0,this.progress.percentage=0,this.progress.unit=Math.round(1/t*100);let e=new Date().getTime();t=1;for(let l of this.fileList)l.status=="uploading"&&(l.id=t++,await this.uploadFunc(l));console.log("total time:",new Date().getTime()-e)},async uploadFunc(t){return new Promise(e=>{let l={albumName:this.albumName,originalImg:"",simplifyImg:""},m=new Date().getTime();var s=new FileReader;s.readAsDataURL(t.raw),s.onload=async o=>{console.log("\u4EFB\u52A1",t.id,"  begin time:",m,"  load time",new Date().getTime()-m),m=new Date().getTime(),l.originalImg=await this.dealImage(o.target.result,1e3),l.simplifyImg=await this.dealImage(l.originalImg,200),console.log("canvas time",new Date().getTime()-m),await I.post("image/add",l,u=>{t.percentage=u.loaded/u.total*100|0}).then(u=>{u.code==200?(t.status="success",this.progress.percentage+this.progress.unit>95?(this.progress.percentage=100,this.progress.status="success"):this.progress.percentage+=this.progress.unit):(t.status="ready",this.progress.status="warning"),e()}).catch(u=>{t.status="ready",this.progress.status="exception",e()}),e()}})},clearAll(){this.fileList=[]},clearUpload(){let t=this.fileList.length;for(let e=0;e<t;e++)this.fileList[e].status=="success"&&(this.fileList.splice(e,1),e--,t--)},closeUpload(){this.uploadDialog=!1,this.progress.show=!1,this.progress.status="",this.progress.percentage=0},saveEditAlbum(){let t=[];this.albumsA.forEach(e=>{let l={};l.id=e.id,l.author="",l.albumName=e.albumName,e.imgChange?l.coverImg=e.coverImg:l.coverImg="",t.push(l)}),this.OKFlag=!0,this.$refs.albumRef.forEach(e=>{e.validate(l=>{l||(this.OKFlag=!1)})}),setTimeout(()=>{this.OKFlag&&I.post("album/update",t).then(e=>{e.code==200&&(x({showClose:!0,message:"\u7F16\u8F91\u6210\u529F",type:"success"}),console.log(e.data),this.editAlbumDialog=!1,this.albums=this.albumsA)})},100)},closeEditAlbum(){this.editAlbumDialog=!1},editAlbumUploadHandler(t,e){let l=new FileReader;l.readAsDataURL(t.file),l.onload=async m=>{this.albumsA[e].coverImg=await this.dealImage(m.target.result,200),this.albumsA[e].imgChange=!0}},editAlbumHandleExceed(t,e){this.$refs.editAlbumUploadRef[e].clearFiles(),this.$refs.editAlbumUploadRef[e].handleStart(t[0]);let l=new FileReader;l.readAsDataURL(t[0]),l.onload=async m=>{this.albumsA[e].coverImg=await this.dealImage(m.target.result,200)}},deleteAlbum(t){H.confirm("\u786E\u8BA4\u5220\u9664?","\u63D0\u793A\u6846",{distinguishCancelAndClose:!0,confirmButtonText:"\u662F",cancelButtonText:"\u5426",type:"warning",customStyle:{top:"-20% !important",position:"relative"}}).then(()=>{this.albumsA.splice(t,1)}).catch(e=>{})},addAlbum(){let t={id:-1,authorId:0,albumName:"\u65B0\u589E\u5206\u7C7B",coverImg:""};this.albumsA.push(t)},albumDialogOpen(){this.albumsA=[],this.albums.forEach(t=>{t.imgChange=!1,this.albumsA.push(JSON.parse(JSON.stringify(t)))})}},computed:{showFlag(){return this.$store.state.isLogin&&this.authorId==this.$store.state.author.username}},watch:{},mounted(){let t={authorId:this.authorId};I.get("init/getAlbums",t).then(e=>{e.code==200&&(e.data.forEach(l=>{l.coverImg=this.baseUrl+l.coverImg,l.albumName!="\u5168\u90E8"&&this.albumsB.push(l.albumName),this.albums.push(l)}),this.$store.commit("setAlbums",e.data))}),t={authorId:this.authorId,startPage:0,pageSize:8},I.get("init/getImages",t).then(e=>{e.code==200&&e.data.forEach(l=>{this.originalImg.push(this.baseUrl+l.originalImg),this.simplifyImg.push(this.baseUrl+l.simplifyImg)})})}},y=t=>(Q("data-v-3bc39237"),t=t(),Y(),t),oe={style:{margin:"0 0 1% 2.5%",height:"30px",opacity:"0.7"}},re={style:{margin:"0 2.5% 1% 0",height:"30px",opacity:"0.7"}},ne=y(()=>d("span",{class:"fenlei"},"\u5206\u7C7B",-1)),ue=y(()=>d("hr",{class:"line",align:"center"},null,-1)),de={class:"jutifenlei"},me=y(()=>d("hr",{width:"100%",align:"left"},null,-1)),ce=y(()=>d("span",null,"\u7CBE\u9009",-1)),pe=y(()=>d("hr",{width:"100%",align:"right"},null,-1)),ge={style:{"margin-left":"2%"}},he={style:{margin:"2% 0 0 2%"}},fe={style:{display:"inline-block","margin-left":"2%","max-width":"150px"}},_e={style:{"margin-top":"2%"}},be={style:{width:"200px","margin-top":"10px"}},we={style:{display:"inline-block",width:"150px","margin-top":"10px"}},ye={style:{display:"inline-block",width:"100px","margin-top":"10px","vertical-align":"top"}},ve={style:{margin:"2% 0 0 2%"}},Ie={class:"previewbox"},Ae=["src"];function ke(t,e,l,m,s,o){const u=le,r=q,h=ae,f=se,w=U("router-link"),v=U("Plus"),R=M,E=Z,V=$,F=ee,L=te,D=j,O=z,P=K,S=J;return g(),b("div",null,[a(h,{style:{"margin-top":"60px"}},{default:i(()=>[a(u,{class:"space"}),a(u,{class:"container"},{default:i(()=>[a(h,{style:{display:"flex","justify-content":"space-between"}},{default:i(()=>[d("div",oe,[o.showFlag?(g(),A(r,{key:0,type:"primary",onClick:e[0]||(e[0]=n=>s.uploadDialog=!0)},{default:i(()=>[p("\u4E0A\u4F20")]),_:1})):N("",!0)]),d("div",re,[o.showFlag?(g(),A(r,{key:0,type:"warning",onClick:e[1]||(e[1]=n=>s.editAlbumDialog=!0)},{default:i(()=>[p("\u7BA1\u7406\u76F8\u518C")]),_:1})):N("",!0)])]),_:1}),a(h,{class:"header"},{default:i(()=>[(g(!0),b(k,null,C(s.albums,n=>(g(),A(w,{to:"/AlbumDetail/"+l.authorId+"_"+n.albumName,class:"item",key:n.id},{default:i(()=>[a(f,{fit:"cover",class:"cover",src:n.coverImg,lazy:""},null,8,["src"]),ne,ue,d("span",de,W(n.albumName),1)]),_:2},1032,["to"]))),128))]),_:1}),a(h,{class:"fengexian"},{default:i(()=>[a(u,{span:1}),a(u,{span:10},{default:i(()=>[me]),_:1}),a(u,{span:2,style:{color:"deeppink"}},{default:i(()=>[ce]),_:1}),a(u,{span:10},{default:i(()=>[pe]),_:1}),a(u,{span:1})]),_:1}),a(h,{class:"body"},{default:i(()=>[(g(!0),b(k,null,C(s.simplifyImg,(n,c)=>(g(),b("div",{class:"item",key:c},[a(f,{class:"photo",src:n,fit:"cover",onClick:_=>o.previewImage(c)},null,8,["src","onClick"])]))),128))]),_:1})]),_:1}),a(u,{class:"space"})]),_:1}),a(D,{ref:"uploadRef",modelValue:s.uploadDialog,"onUpdate:modelValue":e[4]||(e[4]=n=>s.uploadDialog=n),top:"60px",width:"64%",style:{"min-width":"820px","border-radius":"20px"},"close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0},{default:i(()=>[d("div",ge,[a(E,{"file-list":s.fileList,"onUpdate:file-list":e[2]||(e[2]=n=>s.fileList=n),ref:"uploadRef","list-type":"picture-card","on-preview":o.handlePictureCardPreview,"on-remove":o.handleRemove,"http-request":o.uploadHandler,"on-exceed":o.exceedHandler,multiple:"",limit:50,accept:".png, .jpg"},{default:i(()=>[a(R,null,{default:i(()=>[a(v)]),_:1})]),_:1},8,["file-list","on-preview","on-remove","http-request","on-exceed"])]),d("div",he,[a(r,{type:"primary",onClick:o.upload},{default:i(()=>[p("\u4E0A\u4F20")]),_:1},8,["onClick"]),a(r,{type:"info",onClick:o.clearAll},{default:i(()=>[p("\u6E05\u7A7A\u5168\u90E8")]),_:1},8,["onClick"]),a(r,{type:"success",onClick:o.clearUpload},{default:i(()=>[p("\u6E05\u7A7A\u5DF2\u4E0A\u4F20")]),_:1},8,["onClick"]),a(r,{type:"warning",onClick:o.stopUpload},{default:i(()=>[p("\u505C\u6B62")]),_:1},8,["onClick"]),a(r,{type:"danger",onClick:o.closeUpload},{default:i(()=>[p("\u5173\u95ED")]),_:1},8,["onClick"]),d("div",fe,[a(F,{modelValue:s.albumName,"onUpdate:modelValue":e[3]||(e[3]=n=>s.albumName=n),placeholder:"\u9009\u62E9\u76F8\u518C"},{default:i(()=>[(g(!0),b(k,null,C(s.albumsB,(n,c)=>(g(),A(V,{key:c,label:n,value:n},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",_e,[X(a(L,{percentage:s.progress.percentage,status:s.progress.status},null,8,["percentage","status"]),[[G,s.progress.show]])])])]),_:1},8,["modelValue"]),a(D,{modelValue:s.editAlbumDialog,"onUpdate:modelValue":e[5]||(e[5]=n=>s.editAlbumDialog=n),top:"60px",width:"50%",style:{"min-width":"500px","border-radius":"20px"},"close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0,onOpen:o.albumDialogOpen},{default:i(()=>[(g(!0),b(k,null,C(s.albumsA,(n,c)=>(g(),b("div",{class:"albumItem",key:c},[a(h,null,{default:i(()=>[a(u,{class:"albumCover"},{default:i(()=>[a(f,{class:"albumCoverImg",fit:"cover",src:n.coverImg,alt:"",lazy:""},null,8,["src"])]),_:2},1024),a(u,{class:"albumInfo"},{default:i(()=>[d("div",be,[a(S,{ref_for:!0,ref:"albumRef",model:s.albumsA[c],rules:s.rules},{default:i(()=>[a(P,{label:"\u76F8\u518C\u540D",prop:"albumName"},{default:i(()=>[a(O,{modelValue:s.albumsA[c].albumName,"onUpdate:modelValue":_=>s.albumsA[c].albumName=_,placeholder:"",disabled:n.albumName=="\u5168\u90E8"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024)]),_:2},1032,["model","rules"])]),d("div",we,[a(E,{ref_for:!0,ref:"editAlbumUploadRef",class:"upload-demo",accept:".png, .jpg","http-request":_=>{o.editAlbumUploadHandler(_,c)},limit:1,"on-exceed":_=>{o.editAlbumHandleExceed(_,c)}},{trigger:i(()=>[a(r,{type:"primary"},{default:i(()=>[p("\u9009\u62E9\u5C01\u9762")]),_:1})]),_:2},1032,["http-request","on-exceed"])]),d("div",ye,[a(r,{type:"danger",onClick:_=>o.deleteAlbum(c),disabled:n.albumName=="\u5168\u90E8"},{default:i(()=>[p("\u5220\u9664 ")]),_:2},1032,["onClick","disabled"])])]),_:2},1024)]),_:2},1024)]))),128)),d("div",ve,[a(r,{type:"primary",onClick:o.saveEditAlbum},{default:i(()=>[p("\u4FDD\u5B58")]),_:1},8,["onClick"]),a(r,{type:"danger",onClick:o.closeEditAlbum},{default:i(()=>[p("\u5173\u95ED")]),_:1},8,["onClick"]),a(r,{type:"warning",onClick:o.addAlbum},{default:i(()=>[p("\u65B0\u589E\u76F8\u518C")]),_:1},8,["onClick"])])]),_:1},8,["modelValue","onOpen"]),a(D,{modelValue:s.previewDialog,"onUpdate:modelValue":e[6]||(e[6]=n=>s.previewDialog=n),width:"70%",top:"60px","append-to-body":!0,style:{"background-color":"aliceblue"}},{default:i(()=>[d("div",Ie,[d("img",{class:"img",src:s.dialogImageUrl,alt:""},null,8,Ae)])]),_:1},8,["modelValue"])])}const Ne=B(ie,[["render",ke],["__scopeId","data-v-3bc39237"]]);export{Ne as default};
